{% extends 'base.html' %}

{% load static %}

{% block links %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">

{% endblock links %}
{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.4.0/wavesurfer.min.js"></script>
{% endblock scripts %}

{% block content %}
<div class="profile-content container contents">
    <div class="profile-head" style="background-image: url({% static 'img/default-profile-cover.jpg' %})">
        <div class="user-info">
            {% if user.profile_img.name == '' %}
            <div class="profile-img img-circle" style="background-image: url('/static/img/default-profile.png')"></div>
            {% else %}
            <div class="profile-img img-circle" style="background-image: url('{{ user.profile_img.url }}')"></div>
            {% endif %}
            <div class="username-info">
                <h2 class="nickname">{{ user.nickname }}</h2>
                <span class="email">{{ user.email }}</span>
            </div>
            <div class="social-info">
                <div class="social-count" >
                    <p class="social-count-title">Total Likes</p>
                    <p class="social-count-num">{{ user.total_liked }}</p>
                </div>
                <div class="social-count" >
                    <p class="social-count-title">Following</p>
                    <p id="following-count" class="social-count-num">{{ user.following.count }}</p>
                </div>
                <div class="social-count" >
                    <p class="social-count-title">Followers</p>
                    <p id="follower-count" class="social-count-num">{{ user.followers.count }}</p>
                </div>
            </div>
        </div>
        {% if user == request.user or request.user.is_anonymous %}
        {% else %}
        {% csrf_token %}
        <button id="follow-btn" class="transition">
            Follow
        </button>
        {% endif %}
    </div>
    <div class="profile-body">
        <div class="profile-body-wrapper">
            <div class="section section-left">
                <div class="menu-wrapper">
                    <button class="profile-body-menu transition"><span>All</span></button>
                    <button class="profile-body-menu transition"><span>Tracks</span></button>
                    <button class="profile-body-menu transition"><span>Comments</span></button>
                    <button class="profile-body-menu transition"><span>Playlist</span></button>
                </div>
                <div class="profile-body-content">
                    <div class="all-tracks tracklist">
                        {% for track in all_tracks %}
                        <div class="track-obj">
                            {% if track.title %}

                            <!--post img-->
                            {% if track.post_img.name == '' %}
                            <div class="track-post-img" style="background-image: url({% static 'img/default-post-img.png' %}); background-size: unset; background-repeat: no-repeat;"></div>
                            {% else %}
                            <div class="track-post-img" style="background-image: url({{ track.post_img.url }});"></div>
                            {% endif %}
                            <!--post img-->
                            <div class="track-social-count">
                                <span class="track-liked">{{ track.liked.count }}</span>
                                <span class="track-commented">{{ track.comment_tracks.count }}</span>
                            </div>
                            <p class="track-title">{{ track.title }}</p>
                            <p class="track-author">{{ track.author }}</p>

                            <div class="waveform-wrapper" >
                                <div class="waveform-loader"></div>
                                <div id="waveform-{{ forloop.counter }}" class="waveform" datasrc="{{ track.author_track.url }}"></div>
                            </div>
                            <div class="track-genre">
                                {% for item in track.genre.all %}
                                <span class="track-genre-item">#{{ item }}</span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="track-title">{{ track.post.title }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="section section-right">
                <h1>section 2</h1>
            </div>
        </div>
    </div>
</div>

{% if user == request.user or request.user.is_anonymous %}

{% else %}

<script>
    // 페이지 로딩이 끝난 후 함수 실행
    $(document).ready(function() {
        // follow-btn 을 클릭했을 때 follow 함수 실행
        document.getElementById("follow-btn").onclick = function() {
            follow();
        };

        get_follow_status();

        function get_follow_status() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (xhttp.responseText === "True") {
                    document.getElementById("follow-btn").innerHTML = "Following";
                }
                else {
                    document.getElementById("follow-btn").innerHTML = "Follow";
                }
            };
            xhttp.open("GET", "{% url 'views:user:follow' pk=user.pk %}", true);
            xhttp.send()
        }

        function change_follower_count(count) {
            document.getElementById("follower-count").innerHTML = count
        }

        // follow 함수
        function follow() {
            // 새로운 HttpRequest 객체 생성
            var xhttp = new XMLHttpRequest();
            // CSRF 토큰 가져와 변수에 저장
            var csrf_token = $('[name=csrfmiddlewaretoken]').val();
            // readyState가 변할 때 마다 실행할 함수 설정
            xhttp.onreadystatechange = function() {
                // 요청의 readyState가 4(complete)인 경우 함수 실행
                if (this.readyState === 4) {

                    // 요청 결과의 status code가 201인 경우
                    if (this.status === 201) {
                        // 버튼의 텍스트를 Following으로 변경
                        document.getElementById("follow-btn").innerHTML = "Following";
                        // change_follower_count 함수에 응답으로 받은 count 입력
                        var count = JSON.parse(xhttp.responseText).count;
                        change_follower_count(count);
                    }

                    // 요청 결과의 status code가 204인 경우
                    else if (this.status === 204) {
                        // 버튼의 텍스트를 Follow로 변경
                        document.getElementById("follow-btn").innerHTML = "Follow";
                        // count 변수에 현재 follower-count 저장
                        var count = document.getElementById("follower-count").innerText;
                        // change_follower_count 함수에 count -1 입력
                        change_follower_count(count - 1);
                    }
                }
            };

            // /user/pk/follow로 POST 요청을 비동기로 보냄
            xhttp.open("POST", "{% url 'views:user:follow' pk=user.pk %}", true);
            // 요청의 헤더에 CSRF 토큰 포함
            xhttp.setRequestHeader('X-CSRFToken', csrf_token);
            // user키의 값으로 요청 보내는 유저 객체 전달
            xhttp.send({"user": "{{ request.user }}"});
        }
    });


</script>

{% endif %}

<script>
    $(document).ready(function() {
        // waveform 클래스를 가진 div 목록 가져옴
        var div_list = document.getElementsByClassName('waveform');
        // 목록을 순회하면서
        for (var i = 0; i < div_list.length; i++) {
            // div의 datasrc 속성의 값을 track_url 변수에 저장
            var track_url = div_list[i].getAttribute('datasrc');
            // waveform을 그려줄 각각의 div에 부여할 id값 생성
            var waveform_id = '#waveform-' + (i + 1);
            // track_url와 waveform_id를 drawTrack 함수에 전달
            drawTrack(track_url, waveform_id)
        }

        // 파일 위치 url과 waveform을 그려줄 div를 지정하는 element_id 인자를 받음
        function drawTrack(url, element_id) {
            // waveform 객체 생성
            var wavesurfer = WaveSurfer.create({
                // 대상 객체 id값(필수)
                container: element_id,
                // 막대 넓이
                barWidth: 4,
                // 막대 높이
                barHeight: 0.8,
                // 커서 이전 부분 색상
                progressColor: '#E2B026',
                // 커서 색상
                cursorColor: 'transparent',
                // 커서 이후 부분 색상
                waveColor: '#333533'
            });
            // waveform 객체 로드
            wavesurfer.load(url);
            // waveform 로딩이 끝나면 함수 실행
            wavesurfer.on("ready", function() {
                // loader를 없애주는 함수
                waveformLoader();
            });
        }
    });

    // loader를 없애주는 함수
    function waveformLoader() {
        // waveform-loader라는 클래스명을 가진 객체 리스트 저장
        var loader = document.getElementsByClassName('waveform-loader');

        // 리스트를 순회하면서 display 속성을 none으로 변경
        for (var i = 0; i < loader.length; i++) {
            loader[i].style.display = 'none';
        }
    }

</script>

{% endblock content %}