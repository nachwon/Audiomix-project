{% extends 'base.html' %}

{% load static %}

{% block links %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">

{% endblock links %}
{% block scripts %}
<script src="{% static 'js/wavesurfer/wavesurfur.min.js' %}"></script>
{% endblock scripts %}

{% block content %}
<div class="profile-content container contents">
    <div class="profile-head" style="background-image: url({% static 'img/default-profile-cover.jpg' %})">
        <div class="user-info">
            {% if user.profile_img.name == '' %}
            <div class="profile-img img-circle" style="background-image: url('/static/img/default-profile.png')"></div>
            {% else %}
            <div class="profile-img img-circle" style="background-image: url('{{ user.profile_img.url }}')"></div>
            {% endif %}
            <div class="username-info">
                <h2 class="nickname">{{ user.nickname }}</h2>
                <span class="email">{{ user.email }}</span>
            </div>
            <div class="social-info">
                <div class="social-count" >
                    <p class="social-count-title">Total Likes</p>
                    <p class="social-count-num">{{ user.total_liked }}</p>
                </div>
                <div class="social-count" >
                    <p class="social-count-title">Following</p>
                    <p id="following-count" class="social-count-num">{{ user.following.count }}</p>
                </div>
                <div class="social-count" >
                    <p class="social-count-title">Followers</p>
                    <p id="follower-count" class="social-count-num">{{ user.followers.count }}</p>
                </div>
            </div>
        </div>
        {% if user == request.user or request.user.is_anonymous %}
        {% else %}
        {% csrf_token %}
        <button id="follow-btn" class="transition">
            Follow
        </button>
        {% endif %}
    </div>
    <div class="profile-body">
        <div class="profile-body-wrapper">
            <div class="section section-left">
                <div class="menu-wrapper">
                    <button class="profile-body-menu transition"><span>All</span></button>
                    <button class="profile-body-menu transition"><span>Tracks</span></button>
                    <button class="profile-body-menu transition"><span>Comments</span></button>
                    <button class="profile-body-menu transition"><span>Playlist</span></button>
                </div>
                <div class="profile-body-content">
                    <div class="all-tracks tracklist">
                        {% for track in all_tracks %}
                        <div class="track-obj">
                            {% if track.title %}

                            <!--post img-->
                            {% if track.post_img.name == '' %}
                            <div class="track-post-img" style="background-image: url({% static 'img/default-post-img.png' %}); background-size: unset; background-repeat: no-repeat;"></div>
                            {% else %}
                            <div class="track-post-img" style="background-image: url({{ track.post_img.url }});"></div>
                            {% endif %}
                            <!--post img-->
                            <div class="track-social-count">
                                <div class="item">
                                    <span id="like-btn" class="glyphicon glyphicon-heart-empty"></span>
                                    <span class="track-liked">{{ track.liked.count }}</span>
                                </div>
                                <div class="item">
                                    <span class="glyphicon glyphicon-music"></span>
                                    <span class="track-commented">{{ track.comment_tracks.count }}</span>
                                </div>

                            </div>
                            <p class="track-title">{{ track.title }}</p>
                            <a href="{% url 'views:user:user-detail' pk=track.author.pk %}"><p class="track-author">{{ track.author }}</p></a>

                            <div class="waveform-wrapper" >
                                <div class="waveform-loader"></div>
                                <div id="waveform-{{ forloop.counter }}" class="waveform" datasrc="{{ track.author_track.url }}"></div>
                            </div>
                            <div class="track-genre">
                                {% for item in track.genre.all %}
                                <span class="track-genre-item">#{{ item }}</span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="track-title">{{ track.post.title }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="section section-right">
                <h1>section 2</h1>
            </div>
        </div>
    </div>
</div>

{% if user == request.user or request.user.is_anonymous %}

{% else %}

<script>
    // 페이지 로딩이 끝난 후 함수 실행
    $(document).ready(function() {
        // follow-btn 을 클릭했을 때 follow 함수 실행
        document.getElementById("follow-btn").onclick = function() {
            follow();
        };
        document.getElementById("like-btn").onclick = function() {
            like()
        };

        get_follow_status();

        // 팔로우 버튼 텍스트 바꿔주는 함수
        function get_follow_status() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (xhttp.responseText === "True") {
                    document.getElementById("follow-btn").innerHTML = "Following";
                }
                else {
                    document.getElementById("follow-btn").innerHTML = "Follow";
                }
            };
            // views:user:follow 뷰에 요청보내서 결과를 가져옴
            // follow 뷰는 현재 유저가 보고있는 유저를 팔로우하고 있으면 True, 아니면 False
            xhttp.open("GET", "{% url 'views:user:follow' pk=user.pk %}", true);
            xhttp.send()
        }

        // count를 받아서 follower-count의 텍스트에 넣어줌
        function change_follower_count(count) {
            document.getElementById("follower-count").innerHTML = count
        }

        // follow 함수
        function follow() {
            // 새로운 HttpRequest 객체 생성
            var xhttp = new XMLHttpRequest();
            // CSRF 토큰 가져와 변수에 저장
            var csrf_token = $('[name=csrfmiddlewaretoken]').val();
            // readyState가 변할 때 마다 실행할 함수 설정
            xhttp.onreadystatechange = function() {
                // 요청의 readyState가 4(complete)인 경우 함수 실행
                if (this.readyState === 4) {

                    // 요청 결과의 status code가 201인 경우
                    if (this.status === 201) {
                        // 버튼의 텍스트를 Following으로 변경
                        document.getElementById("follow-btn").innerHTML = "Following";
                        // change_follower_count 함수에 응답으로 받은 count 입력
                        var count = JSON.parse(xhttp.responseText).count;
                        change_follower_count(count);
                    }

                    // 요청 결과의 status code가 204인 경우
                    else if (this.status === 204) {
                        // 버튼의 텍스트를 Follow로 변경
                        document.getElementById("follow-btn").innerHTML = "Follow";
                        // count 변수에 현재 follower-count 저장
                        var count = document.getElementById("follower-count").innerText;
                        // change_follower_count 함수에 count -1 입력
                        change_follower_count(count - 1);
                    }
                }
            };

            // /user/pk/follow로 POST 요청을 비동기로 보냄
            xhttp.open("POST", "{% url 'views:user:follow' pk=user.pk %}", true);
            // 요청의 헤더에 CSRF 토큰 포함
            xhttp.setRequestHeader('X-CSRFToken', csrf_token);
            // user키의 값으로 요청 보내는 유저 객체 전달
            xhttp.send({"user": "{{ request.user }}"});
        }

        function like() {
            var xhttp = new XMLHttpRequest();
            var csrf_token = $('[name=csrfmiddlewaretoken]').val();

            xhttp.onreadystatechange = function() {
                if(this.readyState === 4) {
                    if(this.status === 200) {
                        document.getElementById("like-btn").classList.toggle("glyphicon-heart-empty", false)
                        document.getElementById("like-btn").classList.toggle("glyphicon-heart", true)
                    }
                }
            };

            // xhttp.open("POST", "{% url 'views:user:like' pk=user.pk %}", true);
            xhttp.setRequestHeader('X-CSRFToken', csrf_token);
            xhttp.send({"user": "{{ request.user }}"});
        }
    });


</script>

<script>

</script>

{% endif %}

<script src="{% static 'js/profile.js' %}" ></script>

{% endblock content %}