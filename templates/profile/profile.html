{% extends 'base.html' %}

{% load static %}

{% block links %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">

{% endblock links %}
{% block scripts %}
{% endblock scripts %}

{% block content %}
<div class="profile-content container contents">
    <div class="profile-head" style="background-image: url({% static 'img/default-profile-cover.jpg' %})">
        <div class="user-info">
            {% if user.profile_img.name == '' %}
            <div class="profile-img img-circle" style="background-image: url('/static/img/default-profile.png')"></div>
            {% else %}
            <div class="profile-img img-circle" style="background-image: url('{{ user.profile_img.url }}')"></div>
            {% endif %}
            <div class="username-info">
                <h2 class="nickname">{{ user.nickname }}</h2>
                <span class="email">{{ user.email }}</span>
            </div>
            <div class="social-info">
                <div class="social-count" >
                    <p class="social-count-title">Total Likes</p>
                    <p class="social-count-num">{{ user.total_liked }}</p>
                </div>
                <div class="social-count" >
                    <p class="social-count-title">Following</p>
                    <p id="following-count" class="social-count-num">{{ user.following.count }}</p>
                </div>
                <div class="social-count" >
                    <p class="social-count-title">Followers</p>
                    <p id="follower-count" class="social-count-num">{{ user.followers.count }}</p>
                </div>
            </div>
        </div>
        {% if user == request.user or request.user.is_anonymous %}
        {% else %}
        {% csrf_token %}
        <button id="follow-btn">
            Follow
        </button>
        {% endif %}
    </div>
    <div class="profile-body">
        <div class="profile-body-wrapper">
            <div class="section section-left">
                <h1>section 1</h1>
            </div>
            <div class="section section-right">
                <h1>section 2</h1>
            </div>
        </div>
    </div>
</div>

{% if user == request.user or request.user.is_anonymous %}

{% else %}

<script>
    // 페이지 로딩이 끝난 후 함수 실행
    $(document).ready(function() {
        // follow-btn 을 클릭했을 때 follow 함수 실행
        document.getElementById("follow-btn").onclick = function() {
            follow();
        };

        get_follow_status();

        function get_follow_status() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (xhttp.responseText === "True") {
                    document.getElementById("follow-btn").innerHTML = "Following";
                }
                else {
                    document.getElementById("follow-btn").innerHTML = "Follow";
                }
            };
            xhttp.open("GET", "{% url 'views:user:follow' pk=user.pk %}", true);
            xhttp.send()
        }

        function change_follower_count(count) {
            document.getElementById("follower-count").innerHTML = count
        }

        // follow 함수
        function follow() {
            // 새로운 HttpRequest 객체 생성
            var xhttp = new XMLHttpRequest();
            // CSRF 토큰 가져와 변수에 저장
            var csrf_token = $('[name=csrfmiddlewaretoken]').val();
            // readyState가 변할 때 마다 실행할 함수 설정
            xhttp.onreadystatechange = function() {
                // 요청의 readyState가 4(complete)인 경우 함수 실행
                if (this.readyState === 4) {

                    // 요청 결과의 status code가 201인 경우
                    if (this.status === 201) {
                        // 버튼의 텍스트를 Following으로 변경
                        document.getElementById("follow-btn").innerHTML = "Following";
                        // change_follower_count 함수에 응답으로 받은 count 입력
                        var count = JSON.parse(xhttp.responseText).count;
                        change_follower_count(count);
                    }

                    // 요청 결과의 status code가 204인 경우
                    else if (this.status === 204) {
                        // 버튼의 텍스트를 Follow로 변경
                        document.getElementById("follow-btn").innerHTML = "Follow";
                        // count 변수에 현재 follower-count 저장
                        var count = document.getElementById("follower-count").innerText;
                        // change_follower_count 함수에 count -1 입력
                        change_follower_count(count - 1);
                    }
                }
            };

            // /user/pk/follow로 POST 요청을 비동기로 보냄
            xhttp.open("POST", "{% url 'views:user:follow' pk=user.pk %}", true);
            // 요청의 헤더에 CSRF 토큰 포함
            xhttp.setRequestHeader('X-CSRFToken', csrf_token);
            // user키의 값으로 요청 보내는 유저 객체 전달
            xhttp.send({"user": "{{ request.user }}"});
        }
    });
</script>


{% endif %}

{% endblock content %}